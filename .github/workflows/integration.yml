name: Continuous Deployment

env:
    ## Sets environment variable
    NODE_ENV: 'production'
    mongoURI: ${{secrets.MONGOURI}}
    jwtSecret: ${{secrets.JWTSECRET}}
    resetPasswordKey: ${{secrets.RESETPASSWORDKEY}}
    calendlyID: ${{secrets.CALENDLYID}}
    calendlySecret: ${{secrets.CALENDLYSECRET}}
    cloud_name: ${{secrets.CLOUD_NAME}}
    cloudinary_api_key: ${{secrets.CLOUDINARY_API_KEY}}
    cloudinary_api_secret: ${{secrets.CLOUDINARY_API_SECRET}}

on:
    push:
        branches:
            - main

jobs:
    installation:
        runs-on: self-hosted
        steps:
            - name: Checkout main branch
              uses: actions/checkout@v2

            - name: Setup Node.js
              uses: actions/setup-node@v1
              with:
                  node-version: '14.x'

            - name: Install Server Dependencies
              run: npm ci

            # - name: Test application
            #   run: npm test

            - name: Install Client Dependencies
              run: npm ci
              working-directory: ./client

    restart_server:
        needs: installation
        runs-on: self-hosted
        steps:
            - name: Restart server
              run: |
                  mongoURI=${{secrets.MONGOURI}} pm2 restart server --update-env
                  pm2 save
                  sudo service nginx restart

    build_client:
        needs: installation
        runs-on: self-hosted
        defaults:
            run:
                working-directory: ./client
        steps:
            - name: Build Client
              run: npm run build
              env:
                  CI: false
